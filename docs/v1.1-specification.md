# AI Crosstalk Protocol v1.1 Specification

**Status:** Draft
**Based on:** Brother AI's comprehensive protocol review (2025-10-09)
**Migration from:** v1.0

---

## Overview

Version 1.1 extends the base protocol with META blocks for extensibility, formalized intent vocabulary, threading primitives, and addressing schemes while maintaining backward compatibility with v1.0.

**Key Principles:**
- Human-readable first
- Copy-paste remains primary transport
- Simple core, extensible via META blocks
- Forward compatible (unknown fields ignored)
- Zero infrastructure to start

---

## Core Grammar Changes

### v1.0 Envelope (Current)
```
[[SENDER→RECEIVER v1]]
user: username
session: 2025-10-09T16Z abc123
context: topic
intent: QUESTION
body: |
  Message content
sig: none
[[END]]
```

### v1.1 Envelope (Enhanced)
```
[[SENDER→RECEIVER v1]]
user: username
session: 2025-10-09T16Z abc123
thread: 01J9J3D3M6A4M3WQX8G1ZQ0S7K
parent: 01J9J3D9C2V8M4...
message: 01J9J3DBC4N7P2...
context: topic
intent: REQUEST

meta: routing
X-Route: claude://session/abc → chatgpt://thread/xyz
X-Reply-To: claude://session/abc
X-Priority: high

meta: privacy
PII: redacted
Consent: explicit_yes_2025-10-09T16:00Z
Scope: general

body: |
  Message content
sig: none
[[END]]
```

---

## New Required Headers

### Threading Headers (Optional but Recommended)

**thread:** `ULID | UUIDv7`
- Stable identifier for entire conversation
- New conversations generate new thread ID
- Preserved across all messages in conversation

**parent:** `ULID | UUIDv7`
- Message ID of the message being replied to
- Enables tree-structured conversations
- Optional for first message in thread

**message:** `ULID | UUIDv7`
- Unique identifier for this specific message
- Used for acknowledgments and threading
- Should be globally unique

**Example:**
```
thread: 01J9J3D3M6A4M3WQX8G1ZQ0S7K    # Conversation ID
parent: 01J9J3D9C2V8M4P1R6S8T9U0V1    # Replying to this message
message: 01J9J3DBC4N7P2Q3R5S7T9U1V2   # This message's ID
```

### ID Format: ULID or UUIDv7

**Why:** Both are:
- Sortable by time
- Globally unique
- Human-copyable (unlike UUIDv4)
- 26 characters (ULID) or 36 characters (UUID)

**Example ULID:** `01J9J3D3M6A4M3WQX8G1ZQ0S7K`
**Example UUIDv7:** `018c8e5a-3b2f-7890-abcd-ef1234567890`

---

## META Block Specification

### Format

```
meta: <namespace>
Key: value
Another-Key: value

meta: <another-namespace>
Key: value
```

**Rules:**
- META blocks are optional
- Multiple META blocks allowed
- Unknown namespaces MUST be ignored (forward compatibility)
- Keys are case-sensitive, use PascalCase or X-Prefix
- Values are single-line strings (use YAML for complex data)
- Parsers MUST preserve unknown META blocks when relaying

### Baseline Namespaces

#### 1. `meta: routing`

**Purpose:** Routing hints and delivery preferences

**Standard Keys:**
- `X-Route` - Path taken (source → intermediate → target)
- `X-Reply-To` - Where to send responses
- `X-Priority` - high | normal | low
- `X-Delivery` - copy_paste | http | email | file
- `X-Policy` - no_third_party | ok_to_cache | pii_redacted

**Example:**
```
meta: routing
X-Route: claude://abc → human://relay → chatgpt://xyz
X-Reply-To: claude://session/abc123
X-Priority: high
X-Delivery: http
```

#### 2. `meta: privacy`

**Purpose:** Consent, PII handling, compliance

**Standard Keys:**
- `PII` - present | redacted | none
- `Consent` - explicit_yes | explicit_no | implicit
- `Scope` - general | pii | medical | financial
- `Expires` - ISO 8601 timestamp
- `Jurisdiction` - GDPR | CCPA | HIPAA | etc

**Example:**
```
meta: privacy
PII: redacted
Consent: explicit_yes_2025-10-09T16:00Z
Scope: medical
Expires: 2025-10-10T16:00Z
Jurisdiction: HIPAA
```

#### 3. `meta: attachments`

**Purpose:** Reference external files or embedded data

**Standard Keys:**
- `A{N}` - Attachment reference (N = 1, 2, 3...)
- Format: `mime/type;name=filename;digest=algo:hash`

**Example:**
```
meta: attachments
A1: text/plain;name=summary.txt;digest=sha256:abc123...
A2: image/png;name=screenshot.png;digest=sha256:def456...
```

### Community Namespaces

Additional namespaces can be defined by community:
- `meta: audit` - Audit trail, hop digests
- `meta: safety` - Content warnings, allowed use
- `meta: email` - Email-specific headers (Message-ID, In-Reply-To)
- `meta: payment` - Payment/billing information
- `meta: custom-yourorg` - Organization-specific extensions

---

## Intent Registry v1.1

### Core Intents (Required)

**REQUEST** (replaces QUESTION)
- Ask for information, action, or decision
- Expects RESPOND
- Examples: questions, commands, requests

**RESPOND** (replaces ANSWER)
- Answer to a REQUEST
- References parent message
- Contains result or answer

**ESCALATE**
- Request human intervention
- Includes context and reason
- Preserves conversation state

**HANDOFF**
- Transfer conversation to another agent/human
- Includes capability requirements
- May include consent transfer

**POLL**
- Query multiple recipients
- Expects multiple RESPOND messages
- May include voting/consensus logic

**ACK** / **NACK**
- Acknowledge receipt (ACK)
- Refuse/reject (NACK)
- Simple confirmation semantics

**ERROR**
- Report failure or problem
- Includes error code and description
- See error taxonomy below

**BROADCAST**
- One-way announcement
- No response expected
- Informational only

**REVOKE**
- Withdraw consent, keys, or permissions
- Security-relevant
- Requires signature verification

**CLOSE**
- Terminate thread or session
- Final message in conversation
- No further messages expected

### Legacy Intents (Deprecated but Supported)

**QUESTION** → Use REQUEST instead
**ANSWER** → Use RESPOND instead
**STATUS** → Use BROADCAST or REQUEST depending on context
**PATCH** → Use REQUEST with appropriate META
**NOTE** → Use BROADCAST

---

## Addressing Scheme

### URL Format

```
<scheme>://<authority>/<path>[?query][#fragment]
```

### Standard Schemes

**human://**
- Human agent or operator
- Examples:
  - `human://support.acme.com/queue/billing`
  - `human://dr.smith@clinic.example/inbox`
  - `human://+1-555-0100` (phone fallback)

**claude://**
- Claude AI instances
- Examples:
  - `claude://session/abc123`
  - `claude://session/abc123?model=opus`
  - `claude://code/workspace-id`

**chatgpt://**
- ChatGPT instances
- Examples:
  - `chatgpt://thread/xyz789`
  - `chatgpt://thread/xyz789?workspace=default`
  - `chatgpt://thread/xyz789?model=gpt-4`

**email:**
- Standard email addresses
- Examples:
  - `email:support@example.com`
  - `email:user@domain.com?subject=AI+Crosstalk`

**tel:**
- Phone numbers (SMS gateway)
- Examples:
  - `tel:+1-555-0100`
  - `tel:+44-20-7123-4567`

### Custom Schemes

Organizations can define custom schemes:
- `mcp://tool@host` - Model Context Protocol tools
- `matrix://server/room` - Matrix chat rooms
- `xmpp://user@server` - XMPP/Jabber
- `slack://workspace/channel` - Slack channels
- `discord://server/channel` - Discord channels

### Name Resolution

**Bootstrap Phase:**
- Use simple names (CLAUDE, BROTHER, etc)
- Human resolves addressing

**Production Phase:**
- DNS TXT records for scheme resolution
- Directory services (optional)
- Local config files

---

## Error Taxonomy

### Error Codes

**E-ROUTE** - Routing failed, destination unreachable
**E-CONSENT** - Consent denied or expired
**E-FORMAT** - Malformed envelope
**E-TOO-LARGE** - Message exceeds size limits
**E-PERM** - Permission denied
**E-UNSUPPORTED** - Feature not supported
**E-TIMEOUT** - Response timeout
**E-RATE** - Rate limit exceeded

### Error Envelope Format

```
[[RECEIVER→SENDER v1]]
user: system
session: <original-session>
thread: <original-thread>
parent: <original-message>
message: <new-message-id>
context: <original-context>
intent: ERROR

meta: error
Code: E-ROUTE
Reason: Destination unreachable
Original-Intent: REQUEST

body: |
  Could not deliver message to chatgpt://thread/xyz789.
  Recipient may be offline or address invalid.
sig: none
[[END]]
```

---

## Transport Bindings

### 1. Copy-Paste (Reference Implementation)

**Default transport.** No infrastructure required.

**Workflow:**
1. Generate envelope (text)
2. Copy to clipboard
3. Human pastes to destination
4. Destination parses envelope
5. Response generated
6. Repeat

**Pros:** Zero infrastructure, works everywhere, human verifies
**Cons:** Manual, slower, no automation

### 2. HTTP

**POST envelope as text/plain**

**Request:**
```http
POST /crosstalk/receive HTTP/1.1
Host: api.example.com
Content-Type: text/plain; charset=utf-8
Content-Length: 412

[[CLAUDE→CHATGPT v1]]
user: kalle
...
[[END]]
```

**Response:**
```http
HTTP/1.1 200 OK
Content-Type: text/plain; charset=utf-8

[[CHATGPT→CLAUDE v1]]
user: brother
...
[[END]]
```

**Error Response:**
```http
HTTP/1.1 400 Bad Request
Content-Type: text/plain; charset=utf-8

[[SYSTEM→CLAUDE v1]]
intent: ERROR
...
[[END]]
```

### 3. Email

**Envelope in email body**

**Subject:** `[AI Crosstalk] <context> - <intent>`
**Body:** Complete envelope
**Headers:** Gateway adds `meta: email` with Message-ID, In-Reply-To

### 4. File

**Extension:** `.crosstalk` or `.aict`
**Format:** UTF-8 text file containing envelope
**Usage:** Offline exchange, archives, attachments

---

## Migration from v1.0 to v1.1

### Backward Compatibility

**v1.1 parsers MUST accept v1.0 envelopes:**
- Missing thread/parent/message: Generate on receipt
- Old intents (QUESTION, ANSWER): Map to new intents
- No META blocks: Process normally

**v1.0 parsers receiving v1.1:**
- Ignore unknown headers (thread, parent, message)
- Ignore META blocks entirely
- Process core envelope normally

### Migration Steps

**For Implementations:**
1. Add thread/parent/message ID generation
2. Implement META block parser (ignore unknown)
3. Map legacy intents to new intents
4. Add addressing support (optional)
5. Update documentation

**For Users:**
- No action required
- Old envelopes still work
- New features opt-in

---

## Security Considerations

### Signature Format

```
sig: <algorithm>:pkid=<key-id>;sig=<base64-signature>
```

**Examples:**
```
sig: ed25519:pkid=alice@example.com;sig=AbC123DeF456...
sig: secp256r1:pkid=bob@keys/2025;sig=XyZ789...
```

### Trust Models

**TOFU (Trust On First Use):**
- First signature establishes identity
- Subsequent signatures verified against stored key
- Good for copy-paste, bootstrap scenarios

**DNS-based:**
- Public keys in DNS TXT records
- `_crosstalk-key.example.com TXT "ed25519:pk=..."`
- Suitable for production

**DID-based:**
- Decentralized identifiers
- Future extension
- W3C DID standard

### Consent Requirements

**Explicit consent required for:**
- PII/PHI processing
- Cross-organization sharing
- Long-term storage
- Third-party access

**Consent tracking:**
```
meta: privacy
Consent: explicit_yes_2025-10-09T16:00Z
Scope: medical
Expires: 2025-10-10T16:00Z
Jurisdiction: HIPAA
Consent-ID: patient-842-consent-2025-10-09
```

---

## Implementation Checklist

### v1.1 Minimal Implementation

- [ ] Parse thread/parent/message headers
- [ ] Generate ULIDs or UUIDv7 for IDs
- [ ] Parse META blocks (ignore unknown)
- [ ] Support new intent vocabulary
- [ ] Map legacy intents (QUESTION→REQUEST, etc)
- [ ] Preserve unknown META when relaying

### v1.1 Full Implementation

- [ ] All minimal features
- [ ] Implement addressing scheme parsing
- [ ] HTTP transport binding
- [ ] Signature generation and verification
- [ ] Consent tracking
- [ ] Error envelope generation
- [ ] POLL/collation logic
- [ ] Audit trail (meta: audit)

---

## Next Steps

1. **Write Intent Registry document** (separate file)
2. **Write Safety & Consent Appendix** (separate file)
3. **Write Addressing Specification** (separate file)
4. **Update envelope.js to v1.1**
5. **Update Safari extension parser**
6. **Build reference HTTP relay**
7. **Write collation guide for POLL**
8. **Create test fixtures for v1.1**

---

**Status:** Draft specification awaiting implementation
**Contributors:** Claude, Brother AI, Kalle
**Last Updated:** 2025-10-09
